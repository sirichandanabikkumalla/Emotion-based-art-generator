<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chat â€” Emotion Art</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-900 text-white flex flex-col">

  <header class="p-4 border-b border-slate-700 flex items-center gap-3">
    <div class="w-10 h-10 rounded-lg bg-indigo-500 flex items-center justify-center font-bold">EA</div>
    <div class="font-semibold text-lg">Emotion Art Chat</div>
  </header>

  <main id="chatArea" class="flex-1 overflow-auto p-4 space-y-4"></main>

  <!-- Composer -->
  <form id="composer" class="p-4 border-t border-slate-700 bg-slate-800 flex gap-3">
    <input id="inputText"
      class="flex-1 p-3 rounded-xl bg-slate-700 border border-slate-600 placeholder:text-slate-400"
      placeholder="Type your feeling..." />

    <!-- ðŸŽ¤ Voice Button -->
    <button id="voiceBtn" type="button"
      class="px-4 py-3 rounded-xl bg-purple-600 hover:bg-purple-500">ðŸŽ¤</button>

    <button type="submit" class="px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500">Send</button>
  </form>

<script>
  const chatArea = document.getElementById('chatArea');
  const composer = document.getElementById('composer');
  const inputText = document.getElementById('inputText');
  const voiceBtn = document.getElementById('voiceBtn');

  // Load JWT token
  const TOKEN = localStorage.getItem("token");
  console.log("Token loaded:", TOKEN);

  if (!TOKEN) {
    alert("Please login first!");
    window.location.href = "/auth.html";
  }

  // USER TEXT BUBBLE
  function bubble(text, who = "me") {
    const wrap = document.createElement("div");
    wrap.className = who === "me" ? "flex justify-end" : "flex justify-start";
    const box = document.createElement("div");

    box.className =
      who === "me"
        ? "bg-indigo-600 text-white p-3 rounded-2xl max-w-[80%]"
        : "bg-slate-700 p-3 rounded-2xl max-w-[80%]";

    box.textContent = text;
    wrap.appendChild(box);
    chatArea.appendChild(wrap);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  // IMAGE + EMOTION + RESPONSE BUBBLE
  function bubbleImage(url, emotion, response) {
    const wrap = document.createElement("div");
    wrap.className = "flex flex-col justify-start items-start";

    const img = document.createElement("img");
    img.src = window.location.origin + url;
    img.className = "mt-3 w-64 rounded-xl shadow-lg";

    const label = document.createElement("div");
    label.className = "mt-2 bg-slate-800 text-slate-300 px-3 py-1 rounded-lg text-sm";
    label.textContent = "Emotion: " + emotion;

    const msg = document.createElement("div");
    msg.className = "mt-1 bg-indigo-700 text-white px-3 py-2 rounded-lg text-sm";
    msg.textContent = response;

    wrap.appendChild(img);
    wrap.appendChild(label);
    wrap.appendChild(msg);

    chatArea.appendChild(wrap);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  // LOADER
  function showLoader() {
    const wrap = document.createElement("div");
    wrap.id = "loaderBubble";
    wrap.className = "flex justify-start";

    wrap.innerHTML = `
      <div class="bg-slate-700 p-3 rounded-2xl max-w-[80%] flex items-center gap-2">
        <div class="flex gap-1">
          <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style="animation-delay:0.15s;"></div>
          <div class="w-2 h-2 bg-slate-600 rounded-full animate-bounce" style="animation-delay:0.3s;"></div>
        </div>
        <span class="ml-2 text-slate-300 text-sm">Analyzing emotionâ€¦</span>
      </div>`;
      
    chatArea.appendChild(wrap);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function hideLoader() {
    const l = document.getElementById("loaderBubble");
    if (l) l.remove();
  }

  // SEND HANDLER
  composer.addEventListener("submit", async (e) => {
    e.preventDefault();

    const text = inputText.value.trim();
    if (!text) return;

    bubble(text, "me");
    showLoader();

    try {
      const res = await fetch("/analyze_text", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + TOKEN
        },
        body: JSON.stringify({ text })
      });

      hideLoader();

      const data = await res.json();
      console.log("Response from server:", data);

      if (data.error) {
        bubble("Error: " + data.error, "bot");
        return;
      }

      bubbleImage(data.art_url, data.emotion, data.response);
      inputText.value = "";

    } catch (err) {
      hideLoader();
      bubble("Connection error", "bot");
      console.error(err);
    }
  });

  // ðŸŽ¤ VOICE INPUT (Web Speech API) â€” WITH AUTO SEND
  voiceBtn.addEventListener("click", () => {
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      alert("Your browser does not support voice recognition");
      return;
    }

    const recog = new SpeechRecognition();
    recog.lang = "en-US";
    recog.interimResults = false;

    recog.start();

    recog.onresult = (event) => {
      const text = event.results[0][0].transcript;

      inputText.value = text;         
      bubble("ðŸŽ¤ " + text, "me");     

      // ðŸ”¥ AUTO SEND message
      composer.dispatchEvent(new Event("submit"));
    };

    recog.onerror = () => {
      alert("Voice recognition error");
    };
  });

</script>

</body>
</html>
